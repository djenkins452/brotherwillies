{% extends "base.html" %}
{% block title %}Preferences - Brother Willies{% endblock %}

{% block content %}
<style>
/* ── Preferences page: accordion + tile layout ── */

.pref-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}
.pref-header h1 {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0;
}
.pref-header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}
.pref-toggle-link {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 0.8rem;
    cursor: pointer;
    padding: 6px 10px;
    min-height: 36px;
}
.pref-toggle-link:hover { color: var(--text-primary); }

/* ── Accordion sections ── */
.pref-section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 10px;
    overflow: hidden;
    transition: border-color 0.15s;
}
.pref-section:hover {
    border-color: var(--accent);
}

.pref-section-header {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    cursor: pointer;
    user-select: none;
    gap: 12px;
    min-height: 60px;
}
.pref-section-icon {
    font-size: 1.3rem;
    flex-shrink: 0;
    width: 32px;
    text-align: center;
}
.pref-section-info {
    flex: 1;
    min-width: 0;
}
.pref-section-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-primary);
}
.pref-section-subtitle {
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-top: 1px;
}
.pref-section-badge {
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--green);
    white-space: nowrap;
    flex-shrink: 0;
}
.pref-section-chevron {
    color: var(--text-muted);
    font-size: 0.9rem;
    flex-shrink: 0;
    transition: transform 0.2s;
    width: 20px;
    text-align: center;
}
.pref-section.open .pref-section-chevron {
    transform: rotate(180deg);
}

.pref-section-body {
    display: none;
    padding: 0 16px 16px;
    border-top: 1px solid var(--border);
    padding-top: 14px;
}
.pref-section.open .pref-section-body {
    display: block;
}

/* ── Persona tiles ── */
.persona-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}
.persona-tile {
    background: var(--bg-input);
    border: 2px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px 12px;
    cursor: pointer;
    text-align: center;
    transition: border-color 0.15s, background 0.15s;
    min-height: 44px;
}
.persona-tile:hover {
    border-color: var(--accent);
    background: rgba(79, 140, 255, 0.06);
}
.persona-tile.selected {
    border-color: var(--accent);
    background: rgba(79, 140, 255, 0.12);
}
.persona-tile-icon {
    font-size: 1.5rem;
    margin-bottom: 6px;
}
.persona-tile-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}
.persona-tile-desc {
    font-size: 0.72rem;
    color: var(--text-muted);
    line-height: 1.4;
}

/* hidden radio */
.persona-tile input[type="radio"] {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

/* ── Checkbox toggle switch ── */
.toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 8px 0;
}
.toggle-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    cursor: pointer;
}
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
}
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}
.toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 12px;
    transition: background 0.2s;
    cursor: pointer;
}
.toggle-slider::before {
    content: '';
    position: absolute;
    left: 2px;
    top: 2px;
    width: 18px;
    height: 18px;
    background: var(--text-muted);
    border-radius: 50%;
    transition: transform 0.2s, background 0.2s;
}
.toggle-switch input:checked + .toggle-slider {
    background: var(--accent);
    border-color: var(--accent);
}
.toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(20px);
    background: #fff;
}

/* ── Section form fields ── */
.pref-field {
    margin-bottom: 14px;
}
.pref-field:last-child {
    margin-bottom: 0;
}
.pref-field > label {
    display: block;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 5px;
}
.pref-field .form-control {
    width: 100%;
}
.pref-field-help {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 3px;
}
.pref-field-success {
    font-size: 0.75rem;
    color: var(--green);
    margin-top: 3px;
}

/* ── Two-column field grid ── */
.pref-field-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
@media (max-width: 480px) {
    .pref-field-row { grid-template-columns: 1fr; }
    .persona-grid { grid-template-columns: 1fr 1fr; }
}
@media (min-width: 769px) {
    .persona-grid { grid-template-columns: repeat(4, 1fr); }
}

/* ── Favorites sport sub-groups ── */
.fav-sport-group {
    border-bottom: 1px solid var(--border);
    padding-bottom: 14px;
    margin-bottom: 14px;
}
.fav-sport-group:last-child {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 0;
}
.fav-sport-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 10px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.fav-sport-label span {
    font-size: 1.1rem;
}

/* ── Golfer autocomplete ── */
.golfer-search-wrap {
    position: relative;
}
.golfer-search-input {
    width: 100%;
    padding: 12px 14px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: 16px;
    outline: none;
    transition: border-color 0.15s;
}
.golfer-search-input:focus {
    border-color: var(--accent);
}
.golfer-search-input::placeholder {
    color: var(--text-muted);
}
.golfer-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-top: none;
    border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    max-height: 240px;
    overflow-y: auto;
    z-index: 50;
    display: none;
}
.golfer-results.visible {
    display: block;
}
.golfer-result-item {
    padding: 10px 14px;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border);
    min-height: 44px;
    display: flex;
    align-items: center;
}
.golfer-result-item:last-child {
    border-bottom: none;
}
.golfer-result-item:hover,
.golfer-result-item.highlighted {
    background: var(--bg-input);
    color: var(--accent);
}
.golfer-result-empty {
    padding: 10px 14px;
    font-size: 0.8rem;
    color: var(--text-muted);
}
.golfer-selected {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(79, 140, 255, 0.1);
    border: 1px solid var(--accent);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    margin-top: 8px;
}
.golfer-selected-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
}
.golfer-clear-btn {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 1.1rem;
    min-width: 32px;
    min-height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.golfer-clear-btn:hover {
    color: var(--red);
}

/* ── Save button ── */
.pref-save-bar {
    margin-top: 16px;
    margin-bottom: 12px;
}
</style>

<form method="post" id="preferencesForm">
    {% csrf_token %}

    <div class="pref-header">
        <div>
            <h1>Preferences</h1>
            <p class="text-muted text-sm">Customize your Brother Willies experience</p>
        </div>
        <div class="pref-header-actions">
            <button type="button" class="pref-toggle-link" onclick="prefToggleAll(true)">Expand All</button>
            <button type="button" class="pref-toggle-link" onclick="prefToggleAll(false)">Collapse All</button>
            <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
        </div>
    </div>

    <!-- ── 1. AI Persona ── -->
    <div class="pref-section" data-section="persona">
        <div class="pref-section-header" onclick="prefToggle(this)">
            <span class="pref-section-icon">&#129302;</span>
            <div class="pref-section-info">
                <div class="pref-section-title">AI Persona</div>
                <div class="pref-section-subtitle">Tone of AI Insights on game pages</div>
            </div>
            <span class="pref-section-badge" id="personaBadge">{% for value, label in form.ai_persona.field.choices %}{% if value == form.ai_persona.value %}{{ label }}{% endif %}{% endfor %}</span>
            <span class="pref-section-chevron">&#9660;</span>
        </div>
        <div class="pref-section-body">
            <p class="text-muted text-sm mb-2">Choose how the AI communicates with you. This affects the tone of insights on game detail pages.</p>
            <div class="persona-grid">
                <label class="persona-tile{% if form.ai_persona.value == 'analyst' %} selected{% endif %}">
                    <input type="radio" name="ai_persona" value="analyst"{% if form.ai_persona.value == 'analyst' %} checked{% endif %}>
                    <div class="persona-tile-icon">&#128202;</div>
                    <div class="persona-tile-name">Analyst</div>
                    <div class="persona-tile-desc">Neutral, professional, and factual. Just the numbers.</div>
                </label>
                <label class="persona-tile{% if form.ai_persona.value == 'new_york_bookie' %} selected{% endif %}">
                    <input type="radio" name="ai_persona" value="new_york_bookie"{% if form.ai_persona.value == 'new_york_bookie' %} checked{% endif %}>
                    <div class="persona-tile-icon">&#127991;&#65039;</div>
                    <div class="persona-tile-name">New York Bookie</div>
                    <div class="persona-tile-desc">Blunt, sharp, and street-smart. No sugarcoating.</div>
                </label>
                <label class="persona-tile{% if form.ai_persona.value == 'southern_commentator' %} selected{% endif %}">
                    <input type="radio" name="ai_persona" value="southern_commentator"{% if form.ai_persona.value == 'southern_commentator' %} checked{% endif %}>
                    <div class="persona-tile-icon">&#129312;</div>
                    <div class="persona-tile-name">Southern Commentator</div>
                    <div class="persona-tile-desc">Calm, folksy, and confident. Sweet tea wisdom.</div>
                </label>
                <label class="persona-tile{% if form.ai_persona.value == 'ex_player' %} selected{% endif %}">
                    <input type="radio" name="ai_persona" value="ex_player"{% if form.ai_persona.value == 'ex_player' %} checked{% endif %}>
                    <div class="persona-tile-icon">&#127941;</div>
                    <div class="persona-tile-name">Ex-Player</div>
                    <div class="persona-tile-desc">Direct, experiential. Been in the trenches.</div>
                </label>
            </div>
        </div>
    </div>

    <!-- ── 2. Favorites (all sports) ── -->
    {{ form.favorite_golfer }}
    <div class="pref-section" data-section="favorites">
        <div class="pref-section-header" onclick="prefToggle(this)">
            <span class="pref-section-icon">&#11088;</span>
            <div class="pref-section-info">
                <div class="pref-section-title">Favorites</div>
                <div class="pref-section-subtitle">Teams &amp; players across all sports</div>
            </div>
            <span class="pref-section-badge" id="favBadge">{% if profile.favorite_team or profile.favorite_cbb_team or profile.favorite_golfer %}{% if profile.favorite_team %}{{ profile.favorite_team }}{% endif %}{% if profile.favorite_team and profile.favorite_cbb_team %}, {% endif %}{% if profile.favorite_cbb_team %}{{ profile.favorite_cbb_team }}{% endif %}{% if profile.favorite_golfer %}{% if profile.favorite_team or profile.favorite_cbb_team %}, {% endif %}{{ profile.favorite_golfer }}{% endif %}{% else %}None{% endif %}</span>
            <span class="pref-section-chevron">&#9660;</span>
        </div>
        <div class="pref-section-body">
            <!-- CFB -->
            <div class="fav-sport-group">
                <div class="fav-sport-label"><span>&#127944;</span> College Football</div>
                <div class="pref-field-row">
                    <div class="pref-field">
                        <label for="{{ form.favorite_conference.id_for_label }}">Conference</label>
                        {{ form.favorite_conference }}
                    </div>
                    <div class="pref-field">
                        <label for="{{ form.favorite_team.id_for_label }}">Team</label>
                        {{ form.favorite_team }}
                    </div>
                </div>
            </div>

            <!-- CBB -->
            <div class="fav-sport-group">
                <div class="fav-sport-label"><span>&#127936;</span> College Basketball</div>
                <div class="pref-field-row">
                    <div class="pref-field">
                        <label for="{{ form.favorite_cbb_conference.id_for_label }}">Conference</label>
                        {{ form.favorite_cbb_conference }}
                    </div>
                    <div class="pref-field">
                        <label for="{{ form.favorite_cbb_team.id_for_label }}">Team</label>
                        {{ form.favorite_cbb_team }}
                    </div>
                </div>
            </div>

            <!-- Golf -->
            <div class="fav-sport-group">
                <div class="fav-sport-label"><span>&#9971;</span> Golf</div>
                <div class="pref-field">
                    <label for="golferSearchInput">Favorite Golfer</label>
                    <div class="golfer-search-wrap">
                        <input type="text" id="golferSearchInput" class="golfer-search-input"
                               placeholder="Search by name..." autocomplete="off">
                        <div class="golfer-results" id="golferResults"></div>
                    </div>
                    <div class="pref-field-help">Type at least 2 characters to search</div>
                </div>
                <div id="golferSelected" class="golfer-selected" style="{% if not profile.favorite_golfer %}display:none{% endif %}">
                    <span class="golfer-selected-name" id="golferSelectedName">{% if profile.favorite_golfer %}{{ profile.favorite_golfer.name }}{% endif %}</span>
                    <button type="button" class="golfer-clear-btn" onclick="clearGolfer()" title="Remove">&times;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── 3. Value Board Filters ── -->
    <div class="pref-section" data-section="filters">
        <div class="pref-section-header" onclick="prefToggle(this)">
            <span class="pref-section-icon">&#9881;&#65039;</span>
            <div class="pref-section-info">
                <div class="pref-section-title">Value Board Filters</div>
                <div class="pref-section-subtitle">Spread, odds, and edge thresholds</div>
            </div>
            <span class="pref-section-badge">{% if profile.preference_min_edge %}Edge {{ profile.preference_min_edge }}%+{% else %}Default{% endif %}</span>
            <span class="pref-section-chevron">&#9660;</span>
        </div>
        <div class="pref-section-body">
            <div class="toggle-row">
                <span class="toggle-label">Always include favorite team</span>
                <label class="toggle-switch">
                    {{ form.always_include_favorite_team }}
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="pref-field-row mt-2">
                <div class="pref-field">
                    <label for="{{ form.preference_spread_min.id_for_label }}">Spread Min</label>
                    {{ form.preference_spread_min }}
                </div>
                <div class="pref-field">
                    <label for="{{ form.preference_spread_max.id_for_label }}">Spread Max</label>
                    {{ form.preference_spread_max }}
                </div>
            </div>
            <div class="pref-field-row">
                <div class="pref-field">
                    <label for="{{ form.preference_odds_min.id_for_label }}">Odds Min</label>
                    {{ form.preference_odds_min }}
                </div>
                <div class="pref-field">
                    <label for="{{ form.preference_odds_max.id_for_label }}">Odds Max</label>
                    {{ form.preference_odds_max }}
                </div>
            </div>
            <div class="pref-field">
                <label for="{{ form.preference_min_edge.id_for_label }}">Minimum Edge (%)</label>
                {{ form.preference_min_edge }}
                <div class="pref-field-help">Only show games with at least this much house edge</div>
            </div>
        </div>
    </div>

    <!-- ── 4. Location ── -->
    <div class="pref-section" data-section="location">
        <div class="pref-section-header" onclick="prefToggle(this)">
            <span class="pref-section-icon">&#127760;</span>
            <div class="pref-section-info">
                <div class="pref-section-title">Location</div>
                <div class="pref-section-subtitle">Timezone for game times</div>
            </div>
            <span class="pref-section-badge">{% if profile.timezone %}{{ profile.timezone }}{% else %}Not set{% endif %}</span>
            <span class="pref-section-chevron">&#9660;</span>
        </div>
        <div class="pref-section-body">
            <div class="pref-field">
                <label for="{{ form.zip_code.id_for_label }}">US Zip Code</label>
                {{ form.zip_code }}
                <div class="pref-field-help">Enter your 5-digit zip code to set your timezone</div>
                {% if profile.timezone %}
                <div class="pref-field-success">Resolved timezone: {{ profile.timezone }}</div>
                {% endif %}
                {% for error in form.zip_code.errors %}
                <div class="form-error">{{ error }}</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ── Save bar ── -->
    <div class="pref-save-bar">
        <button type="submit" class="btn btn-primary btn-block">Save Changes</button>
    </div>
</form>

<div class="mt-1">
    <a href="/profile/" class="btn btn-secondary btn-sm">&larr; Back to Profile</a>
</div>

<script>
/* ── Accordion toggle ── */
function prefToggle(headerEl) {
    headerEl.closest('.pref-section').classList.toggle('open');
}

function prefToggleAll(open) {
    document.querySelectorAll('.pref-section').forEach(function(s) {
        if (open) s.classList.add('open');
        else s.classList.remove('open');
    });
}

/* ── Persona tile selection ── */
document.querySelectorAll('.persona-tile').forEach(function(tile) {
    tile.addEventListener('click', function() {
        document.querySelectorAll('.persona-tile').forEach(function(t) {
            t.classList.remove('selected');
        });
        tile.classList.add('selected');
        tile.querySelector('input[type="radio"]').checked = true;
        var badge = document.getElementById('personaBadge');
        if (badge) badge.textContent = tile.querySelector('.persona-tile-name').textContent;
    });
});

/* ── Open sections that have validation errors ── */
document.querySelectorAll('.pref-section-body .form-error').forEach(function(err) {
    var section = err.closest('.pref-section');
    if (section) section.classList.add('open');
});

/* ── Golfer autocomplete search ── */
(function() {
    var input = document.getElementById('golferSearchInput');
    var results = document.getElementById('golferResults');
    var hidden = document.getElementById('{{ form.favorite_golfer.id_for_label }}');
    var selectedBox = document.getElementById('golferSelected');
    var selectedName = document.getElementById('golferSelectedName');
    var badge = document.getElementById('favBadge');
    var debounceTimer = null;
    var highlightIdx = -1;
    var currentItems = [];

    if (!input || !results || !hidden) return;

    input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        var q = input.value.trim();
        if (q.length < 2) {
            results.innerHTML = '';
            results.classList.remove('visible');
            highlightIdx = -1;
            return;
        }
        debounceTimer = setTimeout(function() {
            fetch('{% url "golf:golfer_search" %}?q=' + encodeURIComponent(q))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    highlightIdx = -1;
                    currentItems = data;
                    if (data.length === 0) {
                        results.innerHTML = '<div class="golfer-result-empty">No golfers found</div>';
                    } else {
                        results.innerHTML = data.map(function(g, i) {
                            return '<div class="golfer-result-item" data-id="' + g.id + '" data-name="' + g.name.replace(/"/g, '&quot;') + '" data-idx="' + i + '">' + g.name + '</div>';
                        }).join('');
                    }
                    results.classList.add('visible');
                    // Attach click handlers
                    results.querySelectorAll('.golfer-result-item').forEach(function(item) {
                        item.addEventListener('click', function() {
                            selectGolfer(item.dataset.id, item.dataset.name);
                        });
                    });
                });
        }, 250);
    });

    // Keyboard navigation
    input.addEventListener('keydown', function(e) {
        var items = results.querySelectorAll('.golfer-result-item');
        if (!items.length) return;
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            highlightIdx = Math.min(highlightIdx + 1, items.length - 1);
            updateHighlight(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            highlightIdx = Math.max(highlightIdx - 1, 0);
            updateHighlight(items);
        } else if (e.key === 'Enter' && highlightIdx >= 0) {
            e.preventDefault();
            var item = items[highlightIdx];
            selectGolfer(item.dataset.id, item.dataset.name);
        } else if (e.key === 'Escape') {
            results.classList.remove('visible');
            highlightIdx = -1;
        }
    });

    function updateHighlight(items) {
        items.forEach(function(it, i) {
            it.classList.toggle('highlighted', i === highlightIdx);
        });
        if (highlightIdx >= 0 && items[highlightIdx]) {
            items[highlightIdx].scrollIntoView({ block: 'nearest' });
        }
    }

    function rebuildFavBadge(golferName) {
        if (!badge) return;
        var parts = [];
        var teamSel = document.getElementById('id_favorite_team');
        var cbbSel = document.getElementById('id_favorite_cbb_team');
        if (teamSel && teamSel.selectedIndex > 0) parts.push(teamSel.options[teamSel.selectedIndex].text);
        if (cbbSel && cbbSel.selectedIndex > 0) parts.push(cbbSel.options[cbbSel.selectedIndex].text);
        if (golferName) parts.push(golferName);
        badge.textContent = parts.length ? parts.join(', ') : 'None';
    }

    function selectGolfer(id, name) {
        hidden.value = id;
        input.value = '';
        results.innerHTML = '';
        results.classList.remove('visible');
        selectedName.textContent = name;
        selectedBox.style.display = 'flex';
        rebuildFavBadge(name);
    }

    // Make clearGolfer global
    window.clearGolfer = function() {
        hidden.value = '';
        selectedBox.style.display = 'none';
        selectedName.textContent = '';
        rebuildFavBadge(null);
    };

    // Close results on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.golfer-search-wrap')) {
            results.classList.remove('visible');
        }
    });
})();
</script>
{% endblock %}
