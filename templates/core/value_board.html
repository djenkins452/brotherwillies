{% extends "base.html" %}
{% load tz_extras %}
{% block title %}Value Board - Brother Willies{% endblock %}

{% block content %}
<h1 class="page-title">Value Board</h1>

{% if available_sports %}
<div class="sport-tabs">
    {% for s in available_sports %}
    <a href="?sport={{ s.key }}"
       class="sport-tab {% if s.key == active_sport %}active{% endif %}">
        {% if s.key == 'cbb' %}
        <svg class="sport-tab-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M4.93 4.93l14.14 14.14"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10"/><path d="M12 2a15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0 4 10"/></svg>
        {% elif s.key == 'cfb' %}
        <svg class="sport-tab-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="12" rx="10" ry="6" transform="rotate(45 12 12)"/><path d="M7.5 7.5l9 9"/><path d="M9.5 6.1L6.1 9.5"/><path d="M17.9 14.5l-3.4 3.4"/></svg>
        {% elif s.key == 'golf' %}
        <svg class="sport-tab-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v14"/><path d="M12 2l7 4-7 4"/><path d="M6 22c0-2.5 2.7-4 6-4s6 1.5 6 4"/></svg>
        {% endif %}
        {{ s.label }}
        {% if s.count %}<span class="sport-tab-count">{{ s.count }}</span>{% endif %}
    </a>
    {% endfor %}
</div>
{% endif %}

{% if is_offseason and active_sport == 'cfb' %}
<div class="offseason-banner">
    <strong>Offseason</strong> &mdash; CFB season runs August through January. The games below are sample data for demonstration purposes only.
</div>
{% endif %}

{% if show_bye_message %}
<div class="card" style="border-color: var(--yellow);">
    <span class="badge badge-fav">Your Team</span>
    <span class="text-sm text-muted"> No games scheduled this week.</span>
</div>
{% endif %}

{% if active_sport == 'golf' %}
{# Golf: wrap in single accordion section #}
<div class="vb-section" data-section-key="golf_upcoming" data-default-open="true">
    <div class="vb-section-header" onclick="toggleVBSection('golf_upcoming')">
        <svg class="vb-section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v14"/><path d="M12 2l7 4-7 4"/><path d="M6 22c0-2.5 2.7-4 6-4s6 1.5 6 4"/></svg>
        <span class="vb-section-title">Upcoming Tournaments</span>
        <span class="vb-section-count">{{ golf_events|length }}</span>
        <span class="vb-section-chevron">&#9660;</span>
    </div>
    <div class="vb-section-body">
        {% for event in golf_events %}
        <a href="/golf/" class="game-card">
            <div class="teams">
                <span class="team-name">{{ event.name }}</span>
            </div>
            <div class="game-meta">
                <span>{{ event.start_date|date:"D M d" }} &ndash; {{ event.end_date|date:"D M d" }}</span>
            </div>
        </a>
        {% empty %}
        <div class="empty-state">
            <p>No upcoming golf events.</p>
        </div>
        {% endfor %}
    </div>
</div>

{% else %}
{# CFB / CBB games view #}
<div class="filter-bar">
    <span class="filter-label">Sort:</span>
    <a href="?sport={{ active_sport }}&sort=house_edge" class="filter-chip {% if sort_by == 'house_edge' %}active{% endif %}">House Edge</a>
    {% if user.is_authenticated %}
    <a href="?sport={{ active_sport }}&sort=user_edge" class="filter-chip {% if sort_by == 'user_edge' %}active{% endif %}">Your Edge</a>
    <a href="?sport={{ active_sport }}&sort=delta" class="filter-chip {% if sort_by == 'delta' %}active{% endif %}">Delta</a>
    {% endif %}
</div>

{% for section in game_sections %}
<div class="vb-section" data-section-key="{{ section.key }}" data-default-open="{{ section.default_open|yesno:'true,false' }}">
    <div class="vb-section-header" onclick="toggleVBSection('{{ section.key }}')">
        {% if section.key == 'big_games' %}
        <svg class="vb-section-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        {% endif %}
        <span class="vb-section-title">{{ section.label }}</span>
        <span class="vb-section-count">{{ section.count }}</span>
        <span class="vb-section-chevron">&#9660;</span>
    </div>
    <div class="vb-section-body">
        {% for g in section.games %}
        <a href="/{{ active_sport }}/game/{{ g.game.id }}/"
           class="game-card{% if g.is_favorite %} game-card-favorite{% endif %}"
           {% if g.is_favorite and favorite_team_color %}style="--team-color: {{ favorite_team_color }}"{% endif %}>
            {% if g.is_favorite %}
            <span class="badge badge-fav">Your Team</span>
            {% endif %}
            <div class="teams">
                <span class="team-name">{{ g.game.away_team.name }}</span>
                <span class="vs">@</span>
                <span class="team-name">{{ g.game.home_team.name }}</span>
            </div>
            <div class="game-meta">
                {% if active_sport == 'cfb' %}
                <span>{{ g.game.kickoff|date:"D M d, g:i A" }} {% tz_abbr %}</span>
                {% else %}
                <span>{{ g.game.tipoff|date:"D M d, g:i A" }} {% tz_abbr %}</span>
                {% endif %}
                <span class="badge badge-{{ g.confidence_class }}">{{ g.confidence }}</span>
            </div>
            {# ── Compact data grid: all values visible ── #}
            <div class="gc-grid">
                <div class="gc-grid-header">
                    <span></span>
                    <span>Mkt</span>
                    <span>House</span>
                    {% if g.user_prob is not None %}<span>You</span>{% endif %}
                </div>
                <div class="gc-grid-row">
                    <span class="gc-row-label">Prob</span>
                    <span>{{ g.market_prob|floatformat:0 }}%</span>
                    <span>{{ g.house_prob|floatformat:0 }}%</span>
                    {% if g.user_prob is not None %}<span>{{ g.user_prob|floatformat:0 }}%</span>{% endif %}
                </div>
                <div class="gc-grid-row">
                    <span class="gc-row-label">vs Mkt</span>
                    <span class="text-muted">&mdash;</span>
                    <span class="{% if g.house_edge > 0 %}edge-positive{% elif g.house_edge < 0 %}edge-negative{% else %}edge-neutral{% endif %}">{{ g.house_edge|floatformat:1 }}%</span>
                    {% if g.user_edge is not None %}<span class="{% if g.user_edge > 0 %}edge-positive{% elif g.user_edge < 0 %}edge-negative{% else %}edge-neutral{% endif %}">{{ g.user_edge|floatformat:1 }}%</span>{% endif %}
                </div>
                {% if g.delta is not None %}
                <div class="gc-grid-row">
                    <span class="gc-row-label">vs House</span>
                    <span class="text-muted">&mdash;</span>
                    <span class="text-muted">&mdash;</span>
                    <span class="{% if g.delta > 0 %}edge-positive{% elif g.delta < 0 %}edge-negative{% else %}edge-neutral{% endif %}">{{ g.delta|floatformat:1 }}%</span>
                </div>
                {% endif %}
            </div>
            {% if g.line_movement %}
            <div class="text-sm mt-1 {% if g.line_movement == 'up' %}line-up{% else %}line-down{% endif %}">
                Line moved
            </div>
            {% endif %}
        </a>
        {% endfor %}
    </div>
</div>
{% empty %}
<div class="empty-state">
    <p>No games match your current filters.</p>
</div>
{% endfor %}

{% if is_gated %}
<div class="login-gate">
    <p>Showing {{ games_data|length }} of {{ total_count }} games. Log in to unlock the full Value Board.</p>
    <a href="/accounts/login/" class="btn btn-primary btn-sm">Log In</a>
</div>
{% endif %}

{% endif %}
{% endblock %}
